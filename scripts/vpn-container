#!/bin/bash
#
# VPN Container Manager v2.1
# Automatically routes containers through AirVPN
#
# Usage: vpn-container add <container_name> <port>
#        vpn-container remove <container_name> [new_port]
#        vpn-container list
#        vpn-container status

set -e

VPN_CONTAINER="airvpn-wg"
SCRIPT_NAME=$(basename "$0")

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

usage() {
    cat << USAGE
${BOLD}VPN Container Manager v2.1${NC} - Route containers through AirVPN

${CYAN}Usage:${NC} $SCRIPT_NAME <command> [arguments]

${CYAN}Commands:${NC}
  add <container> <port>         Add container to VPN and expose on port
  remove <container> [port]      Remove from VPN, optionally change port
  list                           List all containers using VPN
  status                         Show VPN status, IP, and available ports
  test <container>               Test outbound IP of a container
  ports                          Show used and available ports
  json                           Output status as JSON (for API)

${CYAN}Examples:${NC}
  $SCRIPT_NAME add my-webapp 3000       # Add to VPN on port 3000
  $SCRIPT_NAME remove my-webapp         # Remove from VPN, keep same port
  $SCRIPT_NAME remove my-webapp 8080    # Remove from VPN, change to port 8080
  $SCRIPT_NAME list
  $SCRIPT_NAME test my-webapp

${CYAN}Notes:${NC}
  - Ports are automatically added to VPN container if not available
  - Container will be recreated with appropriate network mode
  - Access your service via localhost:<port> in Cloudflare Tunnel

USAGE
    exit 1
}

check_docker() {
    if ! command -v docker &> /dev/null; then
        log_error "Docker is not installed or not in PATH"
        exit 1
    fi
}

check_vpn_container() {
    if ! docker ps --format '{{.Names}}' | grep -q "^${VPN_CONTAINER}$"; then
        log_error "VPN container '${VPN_CONTAINER}' is not running!"
        log_info "Start it with: docker start ${VPN_CONTAINER}"
        exit 1
    fi
}

get_vpn_ip() {
    docker exec "$VPN_CONTAINER" curl -4 -s --max-time 5 ifconfig.me 2>/dev/null || echo "Unable to fetch"
}

get_host_ip() {
    curl -4 -s --max-time 5 ifconfig.me 2>/dev/null || echo "Unable to fetch"
}

get_vpn_container_id() {
    docker inspect "$VPN_CONTAINER" --format '{{.Id}}' 2>/dev/null
}

is_port_exposed() {
    local port="$1"
    docker port "$VPN_CONTAINER" 2>/dev/null | grep -q ":${port}$" || \
    docker port "$VPN_CONTAINER" 2>/dev/null | grep -q "^${port}/tcp"
}

is_port_in_use() {
    local port="$1"
    ss -tlnp 2>/dev/null | grep -q ":${port} " && return 0
    docker ps --format '{{.Ports}}' | grep -q "0.0.0.0:${port}->\|127.0.0.1:${port}->" && return 0
    return 1
}

get_container_port() {
    local container="$1"
    # Try to find what port this container exposes/listens on
    local ports=$(docker inspect "$container" --format '{{range $p, $conf := .Config.ExposedPorts}}{{$p}} {{end}}' 2>/dev/null)
    if [[ -n "$ports" ]]; then
        echo "$ports" | awk -F'/' '{print $1}' | head -1
    fi
}

is_using_vpn() {
    local container="$1"
    local VPN_CONTAINER_ID=$(get_vpn_container_id)
    local NETWORK_MODE=$(docker inspect "$container" --format '{{.HostConfig.NetworkMode}}' 2>/dev/null)
    [[ "$NETWORK_MODE" == "container:$VPN_CONTAINER_ID" ]] || [[ "$NETWORK_MODE" == "container:$VPN_CONTAINER" ]]
}

add_port_to_vpn() {
    local port="$1"
    
    log_info "Port $port not available on VPN container. Adding it now..."
    
    local IMAGE=$(docker inspect "$VPN_CONTAINER" --format '{{.Config.Image}}')
    local RESTART=$(docker inspect "$VPN_CONTAINER" --format '{{.HostConfig.RestartPolicy.Name}}')
    local CURRENT_PORTS=$(docker inspect "$VPN_CONTAINER" --format '{{range $p, $conf := .HostConfig.PortBindings}}{{range $conf}}-p {{.HostIp}}:{{.HostPort}}:{{$p}} {{end}}{{end}}' | sed 's/:::/0.0.0.0:/g')
    local VOLUMES=$(docker inspect "$VPN_CONTAINER" --format '{{range .Mounts}}-v {{.Source}}:{{.Destination}}{{if .RW}}{{else}}:ro{{end}} {{end}}')
    local CAPS=$(docker inspect "$VPN_CONTAINER" --format '{{range .HostConfig.CapAdd}}--cap-add {{.}} {{end}}')
    local SYSCTLS=$(docker inspect "$VPN_CONTAINER" --format '{{range $k, $v := .HostConfig.Sysctls}}--sysctl {{$k}}={{$v}} {{end}}')
    local PRIVILEGED=""
    [[ $(docker inspect "$VPN_CONTAINER" --format '{{.HostConfig.Privileged}}') == "true" ]] && PRIVILEGED="--privileged"
    local NETWORK=$(docker inspect "$VPN_CONTAINER" --format '{{range $k, $v := .NetworkSettings.Networks}}{{$k}}{{end}}' | head -1)
    
    local VPN_ID=$(get_vpn_container_id)
    local DEPENDENT_CONTAINERS=$(docker ps -a --format '{{.Names}}' | while read c; do
        local nm=$(docker inspect "$c" --format '{{.HostConfig.NetworkMode}}' 2>/dev/null)
        if [[ "$nm" == "container:$VPN_ID" ]] || [[ "$nm" == "container:$VPN_CONTAINER" ]]; then
            echo "$c"
        fi
    done)
    
    if [[ -n "$DEPENDENT_CONTAINERS" ]]; then
        log_info "Stopping dependent containers..."
        for c in $DEPENDENT_CONTAINERS; do
            docker stop "$c" >/dev/null 2>&1 || true
        done
    fi
    
    log_info "Recreating VPN container with new port..."
    docker stop "$VPN_CONTAINER" >/dev/null 2>&1 || true
    docker rm "$VPN_CONTAINER" >/dev/null 2>&1 || true
    
    local RUN_CMD="docker run -d --name $VPN_CONTAINER"
    [[ -n "$NETWORK" ]] && RUN_CMD="$RUN_CMD --network $NETWORK"
    [[ -n "$RESTART" && "$RESTART" != "no" ]] && RUN_CMD="$RUN_CMD --restart $RESTART"
    [[ -n "$PRIVILEGED" ]] && RUN_CMD="$RUN_CMD $PRIVILEGED"
    [[ -n "$CAPS" ]] && RUN_CMD="$RUN_CMD $CAPS"
    [[ -n "$SYSCTLS" ]] && RUN_CMD="$RUN_CMD $SYSCTLS"
    RUN_CMD="$RUN_CMD $CURRENT_PORTS"
    RUN_CMD="$RUN_CMD -p 127.0.0.1:${port}:${port}"
    [[ -n "$VOLUMES" ]] && RUN_CMD="$RUN_CMD $VOLUMES"
    
    while IFS= read -r env; do
        [[ -n "$env" ]] && RUN_CMD="$RUN_CMD -e \"$env\""
    done <<< "$(docker inspect "$VPN_CONTAINER" --format '{{range .Config.Env}}{{.}}
{{end}}' 2>/dev/null || true)"
    
    RUN_CMD="$RUN_CMD $IMAGE"
    eval "$RUN_CMD" >/dev/null 2>&1
    
    log_info "Waiting for VPN connection..."
    sleep 5
    
    if [[ -n "$DEPENDENT_CONTAINERS" ]]; then
        log_info "Starting dependent containers..."
        for c in $DEPENDENT_CONTAINERS; do
            docker start "$c" >/dev/null 2>&1 || true
        done
    fi
    
    log_success "Port $port added to VPN container"
}

cmd_status() {
    check_docker
    check_vpn_container
    
    echo -e "\n${BOLD}${BLUE}=== VPN Container Status ===${NC}\n"
    
    VPN_IP=$(get_vpn_ip)
    HOST_IP=$(get_host_ip)
    VPN_CONTAINER_ID=$(get_vpn_container_id | cut -c1-12)
    
    echo -e "${CYAN}VPN Container:${NC}  $VPN_CONTAINER ($VPN_CONTAINER_ID)"
    echo -e "${CYAN}VPN Exit IP:${NC}    ${GREEN}${BOLD}$VPN_IP${NC}"
    echo -e "${CYAN}Host Exit IP:${NC}   $HOST_IP"
    echo -e "${CYAN}Status:${NC}         $(docker inspect "$VPN_CONTAINER" --format '{{.State.Status}}')"
    
    echo -e "\n${CYAN}WireGuard:${NC}"
    docker exec "$VPN_CONTAINER" ip addr show wg0 2>/dev/null | grep "inet " | awk '{print "  Internal IP: "$2}'
    
    echo -e "\n${CYAN}Exposed Ports (localhost):${NC}"
    docker port "$VPN_CONTAINER" 2>/dev/null | grep "127.0.0.1:" | while read line; do
        PORT=$(echo "$line" | sed 's/.*127.0.0.1:\([0-9]*\).*/\1/')
        echo "  - localhost:$PORT"
    done
    
    echo ""
}

cmd_json() {
    check_docker
    check_vpn_container
    
    VPN_IP=$(get_vpn_ip)
    HOST_IP=$(get_host_ip)
    VPN_CONTAINER_ID=$(get_vpn_container_id | cut -c1-12)
    VPN_STATUS=$(docker inspect "$VPN_CONTAINER" --format '{{.State.Status}}')
    WG_IP=$(docker exec "$VPN_CONTAINER" ip addr show wg0 2>/dev/null | grep "inet " | awk '{print $2}' | cut -d'/' -f1)
    
    # Get ports
    PORTS_JSON=$(docker port "$VPN_CONTAINER" 2>/dev/null | grep "127.0.0.1:" | while read line; do
        PORT=$(echo "$line" | sed 's/.*127.0.0.1:\([0-9]*\).*/\1/')
        echo "$PORT"
    done | jq -R . | jq -s .)
    
    # Get containers using VPN
    VPN_FULL_ID=$(get_vpn_container_id)
    CONTAINERS_JSON=$(docker ps -a --format '{{.Names}}' | while read container; do
        NETWORK_MODE=$(docker inspect "$container" --format '{{.HostConfig.NetworkMode}}' 2>/dev/null)
        if [[ "$NETWORK_MODE" == "container:$VPN_FULL_ID" ]] || [[ "$NETWORK_MODE" == "container:$VPN_CONTAINER" ]]; then
            STATUS=$(docker inspect "$container" --format '{{.State.Status}}')
            if [[ "$STATUS" == "running" ]]; then
                IP=$(docker exec "$container" curl -4 -s --max-time 2 ifconfig.me 2>/dev/null || echo "")
            else
                IP=""
            fi
            echo "{\"name\":\"$container\",\"status\":\"$STATUS\",\"ip\":\"$IP\"}"
        fi
    done | jq -s .)
    
    # Get all containers (not using VPN)
    ALL_CONTAINERS_JSON=$(docker ps -a --format '{{.Names}}' | while read container; do
        [[ "$container" == "$VPN_CONTAINER" ]] && continue
        NETWORK_MODE=$(docker inspect "$container" --format '{{.HostConfig.NetworkMode}}' 2>/dev/null)
        if [[ "$NETWORK_MODE" != "container:$VPN_FULL_ID" ]] && [[ "$NETWORK_MODE" != "container:$VPN_CONTAINER" ]]; then
            STATUS=$(docker inspect "$container" --format '{{.State.Status}}')
            echo "{\"name\":\"$container\",\"status\":\"$STATUS\",\"usingVpn\":false}"
        fi
    done | jq -s .)
    
    cat << EOF
{
  "vpnContainer": "$VPN_CONTAINER",
  "vpnContainerId": "$VPN_CONTAINER_ID",
  "vpnIp": "$VPN_IP",
  "hostIp": "$HOST_IP",
  "vpnStatus": "$VPN_STATUS",
  "wireguardIp": "$WG_IP",
  "ports": $PORTS_JSON,
  "vpnContainers": $CONTAINERS_JSON,
  "otherContainers": $ALL_CONTAINERS_JSON
}
EOF
}

cmd_ports() {
    check_docker
    check_vpn_container
    
    echo -e "\n${BOLD}${BLUE}=== Port Status ===${NC}\n"
    
    echo -e "${CYAN}Used Ports:${NC}"
    docker port "$VPN_CONTAINER" 2>/dev/null | grep "127.0.0.1:" | while read line; do
        PORT=$(echo "$line" | sed 's/.*127.0.0.1:\([0-9]*\).*/\1/')
        INTERNAL=$(echo "$line" | cut -d'/' -f1)
        echo "  localhost:$PORT -> container:$INTERNAL"
    done
    
    echo -e "\n${CYAN}Note:${NC} Any port can be added automatically when you run:"
    echo "  $SCRIPT_NAME add <container> <port>"
    echo ""
}

cmd_list() {
    check_docker
    check_vpn_container
    
    VPN_CONTAINER_ID=$(get_vpn_container_id)
    VPN_IP=$(get_vpn_ip)
    
    echo -e "\n${BOLD}${BLUE}=== Containers Using VPN ===${NC}\n"
    echo -e "${CYAN}VPN Exit IP: ${GREEN}${BOLD}$VPN_IP${NC}\n"
    
    printf "${BOLD}%-25s %-12s %-15s${NC}\n" "CONTAINER" "STATUS" "OUTBOUND IP"
    printf "%-25s %-12s %-15s\n" "─────────" "──────" "───────────"
    
    docker ps -a --format '{{.Names}}' | while read container; do
        NETWORK_MODE=$(docker inspect "$container" --format '{{.HostConfig.NetworkMode}}' 2>/dev/null)
        if [[ "$NETWORK_MODE" == "container:$VPN_CONTAINER_ID" ]] || [[ "$NETWORK_MODE" == "container:$VPN_CONTAINER" ]]; then
            STATUS=$(docker inspect "$container" --format '{{.State.Status}}')
            
            if [[ "$STATUS" == "running" ]]; then
                IP=$(docker exec "$container" curl -4 -s --max-time 3 ifconfig.me 2>/dev/null || echo "N/A")
            else
                IP="-"
            fi
            
            if [[ "$STATUS" == "running" ]]; then
                STATUS_CLR="${GREEN}running${NC}"
            else
                STATUS_CLR="${RED}$STATUS${NC}"
            fi
            
            printf "%-25s %-23b %-15s\n" "$container" "$STATUS_CLR" "$IP"
        fi
    done
    
    echo ""
}

cmd_test() {
    local container="$1"
    
    if [[ -z "$container" ]]; then
        log_error "Container name required"
        echo "Usage: $SCRIPT_NAME test <container_name>"
        exit 1
    fi
    
    check_docker
    
    if ! docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
        log_error "Container '$container' is not running"
        exit 1
    fi
    
    log_info "Testing outbound IP for '$container'..."
    
    IP=$(docker exec "$container" curl -4 -s --max-time 10 ifconfig.me 2>/dev/null)
    
    if [[ -n "$IP" ]]; then
        VPN_IP=$(get_vpn_ip)
        HOST_IP=$(get_host_ip)
        echo ""
        if [[ "$IP" == "$VPN_IP" ]]; then
            echo -e "${GREEN}${BOLD}✓ Container is using VPN${NC}"
            echo -e "  Outbound IP: ${BOLD}$IP${NC} (VPN)"
        elif [[ "$IP" == "$HOST_IP" ]]; then
            echo -e "${YELLOW}${BOLD}⚠ Container is using HOST network${NC}"
            echo -e "  Outbound IP: $IP (Host)"
        else
            echo -e "${YELLOW}${BOLD}⚠ Container has different IP${NC}"
            echo -e "  Container IP: $IP"
            echo -e "  VPN IP:       $VPN_IP"
            echo -e "  Host IP:      $HOST_IP"
        fi
        echo ""
    else
        log_error "Could not determine outbound IP"
        log_info "Container may not have curl installed"
    fi
}

cmd_add() {
    local container="$1"
    local port="$2"
    
    if [[ -z "$container" ]] || [[ -z "$port" ]]; then
        log_error "Container name and port required"
        echo "Usage: $SCRIPT_NAME add <container_name> <port>"
        exit 1
    fi
    
    check_docker
    check_vpn_container
    
    if ! [[ "$port" =~ ^[0-9]+$ ]] || [[ "$port" -lt 1 ]] || [[ "$port" -gt 65535 ]]; then
        log_error "Invalid port: $port (must be 1-65535)"
        exit 1
    fi
    
    if ! docker ps -a --format '{{.Names}}' | grep -q "^${container}$"; then
        log_error "Container '$container' not found"
        log_info "Available containers:"
        docker ps -a --format '  - {{.Names}} ({{.Status}})' | head -10
        exit 1
    fi
    
    VPN_CONTAINER_ID=$(get_vpn_container_id)
    CURRENT_NETWORK=$(docker inspect "$container" --format '{{.HostConfig.NetworkMode}}' 2>/dev/null)
    
    if [[ "$CURRENT_NETWORK" == "container:$VPN_CONTAINER_ID" ]] || [[ "$CURRENT_NETWORK" == "container:$VPN_CONTAINER" ]]; then
        log_warn "Container '$container' is already using VPN network"
        VPN_IP=$(get_vpn_ip)
        echo ""
        echo -e "${CYAN}════════════════════════════════════════════${NC}"
        echo -e "${GREEN}${BOLD}Container already on VPN${NC}"
        echo -e "${CYAN}════════════════════════════════════════════${NC}"
        echo -e "  Container:    $container"
        echo -e "  Exit IP:      ${BOLD}$VPN_IP${NC}"
        echo -e "${CYAN}════════════════════════════════════════════${NC}"
        echo ""
        exit 0
    fi
    
    # Check if port is in use by something other than VPN container
    if is_port_in_use "$port"; then
        if ! docker port "$VPN_CONTAINER" 2>/dev/null | grep -q "127.0.0.1:${port}->"; then
            log_error "Port $port is already in use by another service!"
            echo ""
            echo "Used by:"
            ss -tlnp 2>/dev/null | grep ":${port} " | head -3
            echo ""
            log_info "Choose a different port"
            exit 1
        fi
    fi
    
    # Add port to VPN if not available
    if ! is_port_exposed "$port"; then
        add_port_to_vpn "$port"
    fi
    
    log_info "Adding '$container' to VPN network on port $port..."
    
    IMAGE=$(docker inspect "$container" --format '{{.Config.Image}}')
    RESTART_POLICY=$(docker inspect "$container" --format '{{.HostConfig.RestartPolicy.Name}}')
    
    VOLUMES=""
    while IFS= read -r mount; do
        [[ -n "$mount" ]] && VOLUMES="$VOLUMES $mount"
    done <<< "$(docker inspect "$container" --format '{{range .Mounts}}-v {{.Source}}:{{.Destination}}{{if .RW}}{{else}}:ro{{end}}
{{end}}')"
    
    ENV_ARGS=""
    while IFS= read -r env; do
        [[ -n "$env" && ! "$env" =~ ^PATH= && ! "$env" =~ ^HOSTNAME= && ! "$env" =~ ^HOME= ]] && ENV_ARGS="$ENV_ARGS -e \"$env\""
    done <<< "$(docker inspect "$container" --format '{{range .Config.Env}}{{.}}
{{end}}')"
    
    WORKDIR=$(docker inspect "$container" --format '{{.Config.WorkingDir}}')
    
    log_info "Stopping container..."
    docker stop "$container" >/dev/null 2>&1 || true
    
    log_info "Removing container..."
    docker rm "$container" >/dev/null 2>&1
    
    RUN_CMD="docker run -d --name $container"
    RUN_CMD="$RUN_CMD --network container:$VPN_CONTAINER"
    
    [[ -n "$RESTART_POLICY" && "$RESTART_POLICY" != "no" ]] && RUN_CMD="$RUN_CMD --restart $RESTART_POLICY"
    [[ -n "$VOLUMES" ]] && RUN_CMD="$RUN_CMD $VOLUMES"
    [[ -n "$WORKDIR" ]] && RUN_CMD="$RUN_CMD -w \"$WORKDIR\""
    [[ -n "$ENV_ARGS" ]] && RUN_CMD="$RUN_CMD $ENV_ARGS"
    
    RUN_CMD="$RUN_CMD $IMAGE"
    
    log_info "Recreating container with VPN network..."
    eval "$RUN_CMD" >/dev/null 2>&1
    
    sleep 3
    
    if docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
        VPN_IP=$(get_vpn_ip)
        NEW_IP=$(docker exec "$container" curl -4 -s --max-time 5 ifconfig.me 2>/dev/null || echo "$VPN_IP")
        
        echo ""
        echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
        echo -e "${GREEN}${BOLD}✓ SUCCESS - Container added to VPN${NC}"
        echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
        echo -e "  ${BOLD}Container:${NC}      $container"
        echo -e "  ${BOLD}Exit IP:${NC}        ${GREEN}$NEW_IP${NC}"
        echo -e "  ${BOLD}Access URL:${NC}     ${YELLOW}http://localhost:$port${NC}"
        echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
        echo -e "  ${BOLD}Cloudflare Tunnel Config:${NC}"
        echo -e "    Hostname:  your-domain.com"
        echo -e "    Service:   ${YELLOW}http://localhost:$port${NC}"
        echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
        echo ""
    else
        log_error "Failed to start container!"
        echo "Check logs: docker logs $container"
        exit 1
    fi
}

cmd_remove() {
    local container="$1"
    local new_port="$2"
    
    if [[ -z "$container" ]]; then
        log_error "Container name required"
        echo "Usage: $SCRIPT_NAME remove <container_name> [new_port]"
        echo ""
        echo "Examples:"
        echo "  $SCRIPT_NAME remove my-app          # Remove from VPN, keep current port"
        echo "  $SCRIPT_NAME remove my-app 8080     # Remove from VPN, change to port 8080"
        exit 1
    fi
    
    check_docker
    check_vpn_container
    
    if ! docker ps -a --format '{{.Names}}' | grep -q "^${container}$"; then
        log_error "Container '$container' not found"
        exit 1
    fi
    
    # Check if using VPN
    if ! is_using_vpn "$container"; then
        log_warn "Container '$container' is not using VPN network"
        exit 0
    fi
    
    # Get current port from container's exposed ports
    CURRENT_PORT=$(get_container_port "$container")
    
    # Use new port if provided, otherwise keep current
    if [[ -n "$new_port" ]]; then
        if ! [[ "$new_port" =~ ^[0-9]+$ ]] || [[ "$new_port" -lt 1 ]] || [[ "$new_port" -gt 65535 ]]; then
            log_error "Invalid port: $new_port (must be 1-65535)"
            exit 1
        fi
        PORT="$new_port"
        log_info "Will change port to $PORT"
    else
        PORT="$CURRENT_PORT"
        if [[ -z "$PORT" ]]; then
            PORT="80"  # Default fallback
        fi
        log_info "Keeping current port: $PORT"
    fi
    
    # Check if new port is in use
    if [[ -n "$new_port" ]] && is_port_in_use "$new_port"; then
        log_error "Port $new_port is already in use!"
        exit 1
    fi
    
    log_info "Removing '$container' from VPN network..."
    
    # Get container info
    IMAGE=$(docker inspect "$container" --format '{{.Config.Image}}')
    RESTART_POLICY=$(docker inspect "$container" --format '{{.HostConfig.RestartPolicy.Name}}')
    
    VOLUMES=""
    while IFS= read -r mount; do
        [[ -n "$mount" ]] && VOLUMES="$VOLUMES $mount"
    done <<< "$(docker inspect "$container" --format '{{range .Mounts}}-v {{.Source}}:{{.Destination}}{{if .RW}}{{else}}:ro{{end}}
{{end}}')"
    
    ENV_ARGS=""
    while IFS= read -r env; do
        [[ -n "$env" && ! "$env" =~ ^PATH= && ! "$env" =~ ^HOSTNAME= && ! "$env" =~ ^HOME= ]] && ENV_ARGS="$ENV_ARGS -e \"$env\""
    done <<< "$(docker inspect "$container" --format '{{range .Config.Env}}{{.}}
{{end}}')"
    
    WORKDIR=$(docker inspect "$container" --format '{{.Config.WorkingDir}}')
    
    log_info "Stopping container..."
    docker stop "$container" >/dev/null 2>&1 || true
    
    log_info "Removing container..."
    docker rm "$container" >/dev/null 2>&1
    
    # Recreate WITHOUT VPN network (use bridge)
    RUN_CMD="docker run -d --name $container"
    RUN_CMD="$RUN_CMD -p 127.0.0.1:${PORT}:${PORT}"
    
    [[ -n "$RESTART_POLICY" && "$RESTART_POLICY" != "no" ]] && RUN_CMD="$RUN_CMD --restart $RESTART_POLICY"
    [[ -n "$VOLUMES" ]] && RUN_CMD="$RUN_CMD $VOLUMES"
    [[ -n "$WORKDIR" ]] && RUN_CMD="$RUN_CMD -w \"$WORKDIR\""
    [[ -n "$ENV_ARGS" ]] && RUN_CMD="$RUN_CMD $ENV_ARGS"
    
    RUN_CMD="$RUN_CMD $IMAGE"
    
    log_info "Recreating container with bridge network..."
    eval "$RUN_CMD" >/dev/null 2>&1
    
    sleep 3
    
    if docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
        HOST_IP=$(get_host_ip)
        NEW_IP=$(docker exec "$container" curl -4 -s --max-time 5 ifconfig.me 2>/dev/null || echo "$HOST_IP")
        
        echo ""
        echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
        echo -e "${GREEN}${BOLD}✓ SUCCESS - Container removed from VPN${NC}"
        echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
        echo -e "  ${BOLD}Container:${NC}      $container"
        echo -e "  ${BOLD}Exit IP:${NC}        ${YELLOW}$NEW_IP${NC} (Host - NOT VPN)"
        echo -e "  ${BOLD}Access URL:${NC}     ${YELLOW}http://localhost:$PORT${NC}"
        echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
        echo -e "  ${BOLD}Cloudflare Tunnel Config:${NC}"
        echo -e "    Hostname:  your-domain.com"
        echo -e "    Service:   ${YELLOW}http://localhost:$PORT${NC}"
        echo -e "${CYAN}════════════════════════════════════════════════════════════${NC}"
        echo ""
    else
        log_error "Failed to start container!"
        echo "Check logs: docker logs $container"
        exit 1
    fi
}

# Main
check_docker

case "${1:-}" in
    add)
        cmd_add "$2" "$3"
        ;;
    remove)
        cmd_remove "$2" "$3"
        ;;
    list)
        cmd_list
        ;;
    status)
        cmd_status
        ;;
    ports)
        cmd_ports
        ;;
    test)
        cmd_test "$2"
        ;;
    json)
        cmd_json
        ;;
    -h|--help|help)
        usage
        ;;
    *)
        usage
        ;;
esac
